<div class="app-bg"></div>



<div id="calling-popup" class="pulse-call">

    <div id="call-info">üîî MGONJWA MPYA ANAINGIA...</div>

    <button onclick="dismissCall()" style="margin-top:10px; background:black; color:white; border:none; padding:5px 15px; border-radius:10px;">POKEA</button>

</div>



<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<audio id="callSound" src="https://assets.mixkit.co/active_storage/sfx/1353/1353-preview.mp3" loop></audio>



<div id="login-screen">

    <div class="login-box">

        <img src="https://cdn-icons-png.flaticon.com/512/2785/2785482.png" width="80" style="margin-bottom:10px;">

        <h2>DR. WILLIAM CLINIC</h2>

        <div id="patient-inputs">

            <input type="text" id="reg-name" placeholder="Majina Yako Mawili">

            <input type="tel" id="reg-phone" placeholder="Namba ya Simu (07XXXXXXXX)" maxlength="10">

        </div>

        <input type="password" id="doc-pin" placeholder="PIN ya Daktari" style="display: none;">

        <p onclick="toggleDoc()" id="doc-btn" style="font-size: 0.8rem; color: var(--gold); margin: 15px; cursor: pointer;">Ingia kama Daktari</p>

        <button onclick="processAuth()" style="background:var(--gold); width:100%; padding:18px; border-radius:15px; border:none; font-weight:bold; cursor:pointer; font-size:1rem;">ANZA HUDUMA</button>

    </div>

</div>



<div id="main-interface">

    <div class="chat-header">

        <div id="header-user-info">

            <span id="title-text" style="color:var(--gold); font-weight:bold; font-size:1.1rem;">Clinic</span>

            <div id="status-area" style="font-size: 0.7rem; color: #2ed573; display: none;">‚óè Online</div>

        </div>

        <button id="back-btn" onclick="showDashboard()" style="display:none; background:none; border:1px solid var(--gold); color:white; padding:6px 15px; border-radius:20px;">Wagonjwa</button>

    </div>



    <div id="doctor-dashboard">

        <h4 style="color:#888; margin-bottom:20px; font-size:0.8rem;">WAGONJWA WAKO (OFFLINE/ONLINE):</h4>

        <div id="patient-list"></div>

    </div>



    <div id="chat-interface">

        <div class="chat-messages" id="chat-flow"></div>

        <div class="typing-area" id="t-area">

            <div class="input-wrap">

                <input type="text" id="msg-input" placeholder="Andika ujumbe..." onkeypress="if(event.key==='Enter') sendMsg()">

            </div>

            <button class="btn-send" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>

        </div>

    </div>

</div>



<script>

    const firebaseConfig = { databaseURL: "https://drwilliamtz-e44aa-default-rtdb.europe-west1.firebasedatabase.app" };

    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();



    let myData = JSON.parse(localStorage.getItem('william_v3_user'));

    let isDoc = localStorage.getItem('william_v3_isdoc') === 'true';

    let currentRoom = "";



    // AUTH CHECK

    if(myData) {

        document.getElementById('login-screen').style.display = 'none';

        document.getElementById('main-interface').style.display = 'flex';

        isDoc ? showDashboard() : openChat(myData.roomId, "Dr. William");

    }



    function toggleDoc() {

        document.getElementById('patient-inputs').style.display = 'none';

        document.getElementById('doc-pin').style.display = 'block';

        document.getElementById('doc-btn').style.display = 'none';

    }



    function processAuth() {

        const name = document.getElementById('reg-name').value.trim();

        const phone = document.getElementById('reg-phone').value.trim();

        const pin = document.getElementById('doc-pin').value;



        if(pin === "W005") {

            isDoc = true; myData = { name: "Dr. William" };

            localStorage.setItem('william_v3_isdoc', 'true');

        } else {

            if(name.split(' ').length < 2) return alert("Weka majina yako mawili kamili.");

            if(phone.length !== 10 || !phone.startsWith('0')) return alert("Weka namba ya simu sahihi (Tarakimu 10 kuanzia na 0).");

            const roomId = "room_" + phone;

            myData = { name, phone, roomId };

            db.ref('online_patients/' + roomId).set({ ...myData, lastSeen: Date.now(), isNew: true });

        }

        localStorage.setItem('william_v3_user', JSON.stringify(myData));

        location.reload();

    }



    // DOCTOR DASHBOARD

    function showDashboard() {

        document.getElementById('doctor-dashboard').style.display = 'block';

        document.getElementById('chat-interface').style.display = 'none';

        document.getElementById('back-btn').style.display = 'none';

        document.getElementById('title-text').innerText = "Doctor Panel";



        db.ref('online_patients').on('value', snap => {

            const list = document.getElementById('patient-list');

            list.innerHTML = "";

            snap.forEach(child => {

                const p = child.val();

                const isOnline = (Date.now() - p.lastSeen) < 15000;

                

                // Trigger Call Alert if New

                if(isOnline && p.isNew && isDoc) { triggerCall(p.name); }



                list.innerHTML += `

                    <div class="patient-card" onclick="openChat('${child.key}', '${p.name}', '${p.phone}')">

                        <div class="p-details">

                            <b>${p.name}</b><br>

                            <p><i class="fas fa-phone"></i> ${p.phone}</p>

                            <div style="margin-top:5px; font-size:0.7rem;">

                                <span class="dot" style="background:${isOnline ? '#2ed573' : '#ff4757'}"></span>

                                ${isOnline ? 'Active Now' : 'Offline'}

                            </div>

                        </div>

                        <i class="fas fa-chevron-right" style="color:var(--gold)"></i>

                    </div>`;

            });

        });

    }



    function triggerCall(name) {

        const pop = document.getElementById('calling-popup');

        document.getElementById('call-info').innerText = `üîî MGONJWA: ${name.toUpperCase()} ANAINGIA...`;

        pop.style.top = "20px";

        document.getElementById('callSound').play();

    }



    function dismissCall() {

        document.getElementById('calling-popup').style.top = "-150px";

        document.getElementById('callSound').pause();

        // Mark as not new anymore

        db.ref('online_patients').once('value', snap => {

            snap.forEach(c => db.ref('online_patients/'+c.key).update({isNew: false}));

        });

    }



    // CHAT AREA

    function openChat(roomId, title, phone = "") {

        currentRoom = roomId;

        document.getElementById('doctor-dashboard').style.display = 'none';

        document.getElementById('chat-interface').style.display = 'flex';

        document.getElementById('title-text').innerHTML = `${title} <br><small style="font-size:0.6rem; color:#888;">${phone}</small>`;

        if(isDoc) document.getElementById('back-btn').style.display = 'block';



        db.ref('messages/' + roomId).off();

        db.ref('messages/' + roomId).on('child_added', snap => {

            const m = snap.val();

            renderMsg(m.sender, m.text, m.senderPhone || "");

        });



        // Status Heartbeat for Patients

        if(!isDoc) {

            setInterval(() => db.ref('online_patients/' + myData.roomId).update({ lastSeen: Date.now() }), 10000);

        }

    }



    function renderMsg(sender, text, phone) {

        const div = document.createElement('div');

        const me = (isDoc && sender === "Dr. William") || (!isDoc && sender === myData.name);

        div.className = `message ${me ? 'msg-me' : 'msg-other'}`;

        div.innerHTML = `<span class="msg-info">${sender} ${phone ? '('+phone+')' : ''}</span>${text}`;

        document.getElementById('chat-flow').appendChild(div);

        document.getElementById('chat-flow').scrollTop = document.getElementById('chat-flow').scrollHeight;

        if(!me) document.getElementById('notifSound').play();

    }



    function sendMsg() {

        const input = document.getElementById('msg-input');

        if(!input.value.trim()) return;

        db.ref('messages/' + currentRoom).push({

            sender: isDoc ? "Dr. William" : myData.name,

            senderPhone: isDoc ? "" : myData.phone,

            text: input.value.trim()

        });

        input.value = "";

        input.focus();

    }

</script>
