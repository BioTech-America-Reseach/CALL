<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. William - Online Clinic</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#D4AF37">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://meet.jit.si/external_api.js'></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #0a0f1a; color: white; height: 100vh; overflow: hidden; }
        
        #welcome-screen {
            position: fixed; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1629909613654-28e377c37b09?auto=format&fit=crop&q=80');
            background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .welcome-box {
            background: #1a1a1a; padding: 40px; border-radius: 20px; border: 2px solid #D4AF37;
            width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .welcome-box h2 { color: #D4AF37; margin-bottom: 25px; letter-spacing: 2px; }
        .welcome-box input {
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 30px;
            border: 1px solid #333; background: #222; color: white; text-align: center; font-size: 1rem;
        }
        .role-selector { display: flex; gap: 10px; margin: 20px 0; }
        .role-btn {
            flex: 1; padding: 12px; border-radius: 30px; border: 1px solid #555;
            background: #222; color: #aaa; cursor: pointer; transition: 0.3s;
        }
        .role-btn.selected { background: #D4AF37; color: black; font-weight: bold; border-color: #D4AF37; }
        .btn-start {
            background: #D4AF37; border: none; padding: 15px; border-radius: 30px;
            width: 100%; font-weight: bold; cursor: pointer; font-size: 1.1rem; color: black;
        }

        #main-interface { display: none; height: 100%; flex-direction: column; }
        .header {
            background: #151515; padding: 15px 20px; border-bottom: 2px solid #D4AF37;
            display: flex; justify-content: space-between; align-items: center;
        }
        .video-area { flex: 1; position: relative; background: #000; }
        #meet-container { width: 100%; height: 100%; }
        
        .action-bar {
            background: #111; padding: 15px; display: flex; justify-content: space-around;
            border-top: 1px solid #333;
        }
        .action-btn {
            background: transparent; border: none; color: #aaa; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 0.7rem;
        }
        .action-btn i { font-size: 1.3rem; padding: 12px; border-radius: 50%; background: #222; transition: 0.3s; }
        .action-btn:hover i { background: #D4AF37; color: black; }

        #chat-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            background: #1a1a1a; border-top: 3px solid #D4AF37; border-radius: 25px 25px 0 0;
            display: none; flex-direction: column; z-index: 2000; transition: 0.5s;
        }
        .chat-header { padding: 15px 20px; background: #222; display: flex; justify-content: space-between; border-radius: 25px 25px 0 0; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; }
        .msg-me { background: #D4AF37; color: black; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-other { background: #333; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-input-area { padding: 15px; background: #151515; display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px 20px; border-radius: 25px; border: none; background: #2a2a2a; color: white; }
        .send-btn { background: #D4AF37; border: none; color: black; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <div class="welcome-box">
            <h2>üè• DR. WILLIAM</h2>
            <input type="text" id="user-name-input" placeholder="Ingiza Jina Lako">
            <div class="role-selector">
                <button class="role-btn selected" id="role-patient" onclick="setRole('patient')">Mgonjwa</button>
                <button class="role-btn" id="role-doctor" onclick="setRole('doctor')">Daktari</button>
            </div>
            <button class="btn-start" onclick="enterClinic()">INGIA CLINIC</button>
        </div>
    </div>

    <div id="main-interface">
        <div class="header">
            <h3 style="color:#D4AF37;" id="display-name">Dr. William Clinic</h3>
            <button onclick="endSession()" style="background:#c0392b; border:none; color:white; padding:8px 18px; border-radius:20px; font-weight:bold; cursor:pointer;">Ondoka</button>
        </div>
        
        <div class="video-area">
            <div id="meet-container"></div>
            
            <div id="chat-panel">
                <div class="chat-header">
                    <span style="font-weight:bold;"><i class="fas fa-comments"></i> Live Chat</span>
                    <button onclick="toggleChat()" style="background:none; border:none; color:#D4AF37; font-size:1.8rem; cursor:pointer;">&times;</button>
                </div>
                <div class="chat-messages" id="chat-history"></div>
                <div class="chat-input-area">
                    <input type="text" id="msg-input" class="chat-input" placeholder="Andika ujumbe...">
                    <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        
        <div class="action-bar">
            <button class="action-btn" onclick="toggleChat()"><i class="fas fa-comment-dots"></i>Chat</button>
            <button class="action-btn" onclick="openWhatsApp()"><i class="fas fa-camera"></i>Picha</button>
            <button class="action-btn" onclick="startJitsi('video')"><i class="fas fa-sync"></i>Refresh</button>
            <a href="tel:+255762286282" class="action-btn"><i class="fas fa-phone-alt"></i>Simu</a>
        </div>
    </div>

    <script>
        // FIREBASE CONFIGURATION
        const firebaseConfig = {
            databaseURL: "https://drwilliamtz-e44aa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "drwilliamtz-e44aa",
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let userName = "";
        let userRole = "patient";
        let api = null;
        const roomId = "session_dr_william_001"; // Room ya kudumu

        window.setRole = function(role) {
            userRole = role;
            document.getElementById('role-patient').classList.toggle('selected', role === 'patient');
            document.getElementById('role-doctor').classList.toggle('selected', role === 'doctor');
        };

        window.enterClinic = function() {
            const nameInput = document.getElementById('user-name-input').value.trim();
            if(!nameInput) return alert("Tafadhali weka jina lako kwanza.");
            
            userName = userRole === 'doctor' ? "Dr. William" : nameInput;
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('main-interface').style.display = 'flex';
            document.getElementById('display-name').innerText = "Mtumiaji: " + userName;
            
            startJitsi('video');
            listenForMessages();
        };

        function startJitsi(type) {
            const domain = 'meet.jit.si';
            const options = {
                roomName: 'DrWilliam_Secure_Clinic_2024',
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet-container'),
                userInfo: { displayName: userName },
                interfaceConfigOverwrite: {
                    MOBILE_APP_PROMO: false,
                    TOOLBAR_BUTTONS: ['microphone', 'camera', 'hangup', 'chat', 'settings', 'videoquality', 'tileview']
                }
            };
            if(api) api.dispose();
            api = new JitsiMeetExternalAPI(domain, options);
        }

        function listenForMessages() {
            database.ref('live_chats/' + roomId).on('child_added', (snapshot) => {
                const data = snapshot.val();
                const isMe = data.sender === userName;
                renderMessage(data.sender, data.text, isMe);
            });
        }

        function renderMessage(sender, text, isMe) {
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'msg-me' : 'msg-other'}`;
            div.innerHTML = `<strong>${sender}</strong><br>${text}`;
            const history = document.getElementById('chat-history');
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        window.sendMessage = function() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            database.ref('live_chats/' + roomId).push({
                sender: userName,
                text: text,
                timestamp: Date.now()
            });
            input.value = "";
        };

        window.toggleChat = function() {
            const panel = document.getElementById('chat-panel');
            panel.style.display = (panel.style.display === 'flex') ? 'none' : 'flex';
        };

        window.openWhatsApp = function() {
            window.open(`https://wa.me/255762286282?text=Habari Dr. William, naitwa ${userName}, nahitaji kutuma picha ya uchunguzi.`, '_blank');
        };

        window.endSession = function() {
            if(confirm("Je, unataka kufunga huduma?")) {
                if(api) api.dispose();
                location.reload();
            }
        };
    </script>
</body>
</html>
