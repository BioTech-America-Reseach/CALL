<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dr. William - Online Clinic</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PWA Manifest (kwa ajili ya kusakinisha) -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Dr. William">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3774/3774299.png">

    <style>
        :root { 
            --gold: #D4AF37; 
            --bg: #000;
            --green: #2ecc71;
            --red: #e74c3c;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body, html { 
            background: var(--bg); 
            color: white; 
            height: 100%; 
            width: 100%; 
            overflow: hidden;
            position: fixed;
        }

        /* Background ya Dr. William */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://img.freepik.com/free-photo/doctor-with-his-arms-crossed-white-background_1368-5790.jpg');
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            z-index: -1;
        }

        /* Install button */
        #install-container {
            display: none;
            justify-content: center;
            padding: 10px;
            background: #111;
            border-bottom: 2px solid var(--gold);
        }
        #install-btn {
            background: var(--gold);
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        #main-interface { 
            display: none; 
            flex-direction: column; 
            height: 100%; 
        }

        .chat-header { 
            padding: 15px; 
            background: #111; 
            border-bottom: 2px solid var(--gold); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            z-index: 2000;
        }

        .online-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }
        .green-dot {
            width: 10px;
            height: 10px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        #chat-interface { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            height: 100%;
        }

        .chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            padding-bottom: 150px;
        }

        .message { 
            padding: 12px; 
            border-radius: 12px; 
            max-width: 80%; 
            font-size: 0.9rem; 
            position: relative;
        }
        .msg-me { 
            background: var(--gold); 
            color: black; 
            align-self: flex-end; 
        }
        .msg-other { 
            background: #222; 
            color: white; 
            align-self: flex-start; 
        }
        .msg-time { 
            font-size: 0.65rem; 
            color: #aaa; 
            margin-top: 3px; 
            text-align: right; 
        }
        .delete-msg {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--red);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            cursor: pointer;
            opacity: 0;
            transition: 0.2s;
        }
        .message:hover .delete-msg {
            opacity: 1;
        }

        /* Typing area */
        .typing-area {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            background: #111;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid var(--gold);
            z-index: 3000;
            transition: bottom 0.3s ease;
        }
        .typing-area.keyboard-open {
            bottom: 40vh !important;
            background: #1a1a1a;
        }
        .input-wrapper {
            flex: 1;
            background: #222;
            border-radius: 25px;
            padding: 5px 15px;
            border: 2px solid var(--gold);
        }
        .input-wrapper input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            padding: 12px 0;
            font-size: 16px;
            outline: none;
        }
        .btn-send {
            background: var(--gold);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: black;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #111;
            border-top: 1px solid #333;
        }
        .action-btn {
            background: transparent;
            border: none;
            color: #aaa;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .action-btn i {
            font-size: 1.3rem;
            padding: 10px;
            border-radius: 50%;
            background: #222;
        }
        .action-btn:hover i {
            background: var(--gold);
            color: black;
        }

        /* LOGIN SCREEN */
        #login-screen { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.95); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 5000; 
            backdrop-filter: blur(5px);
        }
        .login-box { 
            background: #111; 
            padding: 30px; 
            border-radius: 20px; 
            border: 2px solid var(--gold); 
            width: 90%; 
            max-width: 400px; 
            text-align: center; 
        }
        .login-box input { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 10px; 
            background: #222; 
            color: white; 
            border: 1px solid #333; 
            text-align: center; 
        }
        .login-box .small-link { 
            font-size: 0.8rem; 
            color: var(--gold); 
            margin: 15px; 
            cursor: pointer; 
        }
        .login-box button { 
            background: var(--gold); 
            width:100%; 
            padding:16px; 
            border-radius:12px; 
            border:none; 
            font-weight:bold; 
            cursor: pointer; 
        }

        /* DOCTOR DASHBOARD */
        #doctor-dashboard { 
            display: none; 
            padding: 15px; 
            overflow-y: auto; 
            flex: 1; 
        }
        .notification-banner {
            background: var(--gold);
            color: black;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .patient-card { 
            background: #111; 
            padding: 15px; 
            border-radius: 15px; 
            margin-bottom: 12px; 
            border-left: 5px solid var(--gold); 
            display: flex; 
            flex-direction: column;
            gap: 10px;
        }
        .patient-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .patient-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .patient-phone {
            color: #aaa;
            font-size: 0.8rem;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        .status-online { 
            background: rgba(46, 204, 113, 0.2); 
            color: var(--green); 
            border: 1px solid var(--green);
        }
        .status-waiting { 
            background: rgba(241, 196, 15, 0.2); 
            color: #f1c40f; 
            border: 1px solid #f1c40f;
        }
        .patient-actions {
            display: flex;
            gap: 10px;
        }
        .btn-action {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-hold { background: #f39c12; color: black; }
        .btn-remove { background: var(--red); color: white; }
        .btn-chat { background: var(--gold); color: black; }

        /* Waiting message for patient */
        .waiting-message {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 10px;
            border-left: 5px solid var(--gold);
        }
    </style>
</head>
<body>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <!-- Install Button (PWA) -->
    <div id="install-container">
        <button id="install-btn"><i class="fas fa-download"></i> Sakinisha App</button>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--gold)">üè• DR. WILLIAM</h2>
            <input type="text" id="name-input" placeholder="Jina lako" value="">
            <input type="tel" id="phone-input" placeholder="Namba ya simu (0xxxxxxxxx)" maxlength="10" pattern="[0-9]{10}">
            <input type="password" id="doctor-code" placeholder="PIN ya Daktari" style="display: none;">
            <div class="small-link" onclick="toggleDoctorLogin()">Ingia kama Daktari</div>
            <button onclick="startApp()">INGIA</button>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface">
        <div class="chat-header">
            <div>
                <span id="chat-title" style="color:var(--gold); font-weight:bold;">Dr. William</span>
                <div class="online-indicator" id="online-indicator">
                    <span class="green-dot"></span>
                    <span>Online</span>
                </div>
            </div>
            <button id="back-btn" onclick="goBack()" style="display:none; background:none; color:white; border:1px solid var(--gold); padding:5px 12px; border-radius:15px;">Rudi</button>
        </div>

        <!-- DOCTOR DASHBOARD -->
        <div id="doctor-dashboard">
            <div id="notification-area" class="notification-banner"></div>
            <h4 style="margin-bottom:15px; color:#888;">WAGONJWA WOTE:</h4>
            <div id="patient-list"></div>
        </div>

        <!-- CHAT INTERFACE -->
        <div id="chat-interface" style="display:none;">
            <div class="chat-messages" id="chat-flow"></div>
            
            <div id="waiting-notice" class="waiting-message" style="display:none;">
                ‚è≥ Daktari atajibu hivi karibuni... Tafadhali subiri.
            </div>

            <div class="action-buttons">
                <button class="action-btn" onclick="openWhatsApp()"><i class="fab fa-whatsapp"></i> <span>Picha</span></button>
                <a href="tel:+255762286282" class="action-btn"><i class="fas fa-phone-alt"></i> <span>Simu</span></a>
            </div>

            <div class="typing-area" id="typing-box">
                <div class="input-wrapper">
                    <input type="text" id="msg-input" placeholder="Andika ujumbe..." onfocus="raiseInput()" onblur="lowerInput()">
                </div>
                <button class="btn-send" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIG (BADILISHA HAPA) ====================
        const firebaseConfig = {
            apiKey: "AIzaSyB...",
            authDomain: "drwilliamtz.firebaseapp.com",
            databaseURL: "https://drwilliamtz-e44aa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "drwilliamtz",
            storageBucket: "drwilliamtz.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abc123..."
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ==================== GLOBAL VARIABLES ====================
        let myName = "";
        let myPhone = "";
        let isDoctor = false;
        let activeRoomId = "";
        let myPatientRef = null;
        let currentMessagesListener = null;
        let currentNotification = null;

        // DOM elements
        const loginScreen = document.getElementById('login-screen');
        const mainInterface = document.getElementById('main-interface');
        const doctorDashboard = document.getElementById('doctor-dashboard');
        const chatInterface = document.getElementById('chat-interface');
        const patientListDiv = document.getElementById('patient-list');
        const chatFlow = document.getElementById('chat-flow');
        const msgInput = document.getElementById('msg-input');
        const backBtn = document.getElementById('back-btn');
        const chatTitle = document.getElementById('chat-title');
        const waitingNotice = document.getElementById('waiting-notice');
        const notificationArea = document.getElementById('notification-area');
        const onlineIndicator = document.getElementById('online-indicator');

        // ==================== PWA INSTALL ====================
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-container').style.display = 'flex';
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('Install outcome:', outcome);
            deferredPrompt = null;
            document.getElementById('install-container').style.display = 'none';
        });

        // ==================== LOGIN FUNCTIONS ====================
        function toggleDoctorLogin() {
            const codeInput = document.getElementById('doctor-code');
            codeInput.style.display = codeInput.style.display === 'none' ? 'block' : 'none';
        }

        // Load saved data
        const savedName = localStorage.getItem('drwilliam_name');
        const savedPhone = localStorage.getItem('drwilliam_phone');
        if (savedName) document.getElementById('name-input').value = savedName;
        if (savedPhone) document.getElementById('phone-input').value = savedPhone;

        function startApp() {
            myName = document.getElementById('name-input').value.trim();
            myPhone = document.getElementById('phone-input').value.trim();
            const code = document.getElementById('doctor-code').value.trim();

            if (!myName) return alert("Weka jina lako");
            
            // Validate phone number (10 digits, starts with 0)
            if (!isDoctor) {
                if (!myPhone) return alert("Weka namba ya simu");
                if (!/^0[0-9]{9}$/.test(myPhone)) {
                    return alert("Namba lazima iwe na tarakimu 10 na kuanza na 0 (mfano: 0712345678)");
                }
            }

            // Save to localStorage
            localStorage.setItem('drwilliam_name', myName);
            localStorage.setItem('drwilliam_phone', myPhone);

            if (code === "W005") {
                isDoctor = true;
                showDoctorDashboard();
            } else {
                isDoctor = false;
                activeRoomId = "patient_" + myPhone; // Use phone as unique ID
                
                // Check if patient is blocked
                db.ref('blocked/' + myPhone).once('value', (snap) => {
                    if (snap.exists()) {
                        alert("Samahani, akaunti yako imezuiliwa. Wasiliana na daktari.");
                        return;
                    }
                    
                    // Register patient
                    myPatientRef = db.ref('patients/' + myPhone);
                    myPatientRef.set({
                        name: myName,
                        phone: myPhone,
                        online: true,
                        status: 'waiting',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    myPatientRef.onDisconnect().update({ online: false });

                    openPatientChat(myPhone);
                });
            }

            loginScreen.style.display = 'none';
            mainInterface.style.display = 'flex';
        }

        // ==================== DOCTOR DASHBOARD ====================
        function showDoctorDashboard() {
            doctorDashboard.style.display = 'block';
            chatInterface.style.display = 'none';
            backBtn.style.display = 'none';
            chatTitle.innerText = "Dr. William (Daktari)";
            onlineIndicator.style.display = 'flex';

            // Show doctor as online
            db.ref('doctor_online').set(true);
            db.ref('doctor_online').onDisconnect().set(false);

            // Listen for new patients
            db.ref('patients').on('value', (snap) => {
                renderPatientList(snap);
            });

            // Listen for new patient notifications
            db.ref('patients').limitToLast(1).on('child_added', (snap) => {
                if (snap.key !== activeRoomId) {
                    showNotification(`üÜï Mgonjwa mpya: ${snap.val().name}`);
                }
            });
        }

        function renderPatientList(snap) {
            let html = '';
            snap.forEach((child) => {
                const p = child.val();
                const phone = child.key;
                const isOnline = p.online ? true : false;
                const statusClass = isOnline ? 'status-online' : 'status-waiting';
                const statusText = isOnline ? '‚óè Online' : '‚è≥ Kusubiri';

                html += `
                    <div class="patient-card" data-phone="${phone}">
                        <div class="patient-info">
                            <div>
                                <div class="patient-name">${p.name}</div>
                                <div class="patient-phone">${p.phone}</div>
                            </div>
                            <div class="status-badge ${statusClass}">${statusText}</div>
                        </div>
                        <div class="patient-actions">
                            <button class="btn-action btn-hold" onclick="holdPatient('${phone}')">
                                <i class="fas fa-pause"></i> Subirisha
                            </button>
                            <button class="btn-action btn-remove" onclick="removePatient('${phone}')">
                                <i class="fas fa-ban"></i> Ondoa
                            </button>
                            <button class="btn-action btn-chat" onclick="openDoctorChat('${phone}', '${p.name}')">
                                <i class="fas fa-comment"></i> Chat
                            </button>
                        </div>
                    </div>
                `;
            });
            patientListDiv.innerHTML = html || '<div style="color:#888; text-align:center;">Hakuna wagonjwa</div>';
        }

        // Hold patient (show waiting message)
        window.holdPatient = function(phone) {
            db.ref('patients/' + phone).update({ status: 'waiting' });
            db.ref('waiting/' + phone).set({
                message: "Daktari atajibu hivi karibuni...",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            showNotification(`‚è∏Ô∏è Mgonjwa ${phone} amewekwa subiriani`);
        };

        // Remove patient completely (block)
        window.removePatient = function(phone) {
            if (!confirm('Una uhakika unamtoa kabisa? Hataweza kuingia tena.')) return;
            
            // Add to blocked list
            db.ref('blocked/' + phone).set({
                name: myName,
                phone: phone,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Remove from patients
            db.ref('patients/' + phone).remove();
            
            // Remove all messages
            db.ref('messages/' + phone).remove();
            
            showNotification(`üö´ Mgonjwa ${phone} amezuiliwa`);
        };

        // ==================== PATIENT CHAT ====================
        function openPatientChat(phone) {
            doctorDashboard.style.display = 'none';
            chatInterface.style.display = 'flex';
            backBtn.style.display = 'none';
            chatTitle.innerText = "Dr. William";
            onlineIndicator.style.display = 'flex';

            // Check if doctor is online
            db.ref('doctor_online').on('value', (snap) => {
                if (snap.val()) {
                    onlineIndicator.style.display = 'flex';
                } else {
                    onlineIndicator.innerHTML = '<span class="green-dot" style="background:#aaa;"></span><span>Offline</span>';
                }
            });

            // Check if waiting
            db.ref('waiting/' + phone).on('value', (snap) => {
                waitingNotice.style.display = snap.exists() ? 'block' : 'none';
            });

            listenForMessages(phone);
        }

        // ==================== DOCTOR CHAT WITH PATIENT ====================
        window.openDoctorChat = function(phone, patientName) {
            activeRoomId = phone;
            doctorDashboard.style.display = 'none';
            chatInterface.style.display = 'flex';
            backBtn.style.display = 'block';
            chatTitle.innerText = patientName;
            
            // Remove waiting status when doctor opens chat
            db.ref('waiting/' + phone).remove();

            listenForMessages(phone);
        };

        // ==================== MESSAGING ====================
        function listenForMessages(roomId) {
            if (currentMessagesListener) {
                db.ref('messages/' + roomId).off();
            }

            chatFlow.innerHTML = ''; // Clear chat

            currentMessagesListener = db.ref('messages/' + roomId).orderByChild('timestamp').on('child_added', (snap) => {
                const msg = snap.val();
                renderMessage(msg, snap.key);
            });
        }

        function renderMessage(msg, msgId) {
            const div = document.createElement('div');
            const me = (isDoctor && msg.sender === "Dr. William") || (!isDoctor && msg.sender === myName);
            div.className = `message ${me ? 'msg-me' : 'msg-other'}`;
            div.setAttribute('data-id', msgId);
            
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            
            div.innerHTML = `
                <b>${msg.sender}</b><br>${msg.text}
                <div class="msg-time">${time}</div>
                ${isDoctor ? `<span class="delete-msg" onclick="deleteMessage('${activeRoomId}', '${msgId}')">√ó</span>` : ''}
            `;
            
            chatFlow.appendChild(div);
            chatFlow.scrollTop = chatFlow.scrollHeight;
            if (!me) document.getElementById('notifSound').play();
        }

        window.deleteMessage = function(roomId, msgId) {
            if (confirm('Futa ujumbe huu?')) {
                db.ref('messages/' + roomId + '/' + msgId).remove();
                document.querySelector(`[data-id="${msgId}"]`).remove();
            }
        };

        function sendMsg() {
            const text = msgInput.value.trim();
            if (!text || !activeRoomId) return;
            
            db.ref('messages/' + activeRoomId).push({
                sender: isDoctor ? "Dr. William" : myName,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            msgInput.value = "";
            msgInput.focus();
        }

        // ==================== NOTIFICATIONS ====================
        function showNotification(text) {
            notificationArea.style.display = 'flex';
            notificationArea.innerHTML = `<i class="fas fa-bell"></i> ${text}`;
            
            setTimeout(() => {
                notificationArea.style.display = 'none';
            }, 5000);
        }

        // ==================== UI FUNCTIONS ====================
        function raiseInput() {
            document.getElementById('typing-box').classList.add('keyboard-open');
            setTimeout(() => {
                window.scrollTo(0, 0);
                chatFlow.scrollTop = chatFlow.scrollHeight;
            }, 300);
        }
        function lowerInput() {
            document.getElementById('typing-box').classList.remove('keyboard-open');
        }

        function goBack() {
            if (isDoctor) {
                doctorDashboard.style.display = 'block';
                chatInterface.style.display = 'none';
                backBtn.style.display = 'none';
                chatTitle.innerText = "Dr. William (Daktari)";
                if (currentMessagesListener) {
                    db.ref('messages/' + activeRoomId).off();
                }
            } else {
                location.reload();
            }
        }

        function openWhatsApp() {
            let msg = isDoctor 
                ? `Habari, naitwa Dr. William. Nataka kutuma picha.`
                : `Habari Dr. William, naitwa ${myName} (${myPhone}). Nataka kutuma picha ya tatizo langu.`;
            window.open(`https://wa.me/255762286282?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Check if already logged in
        window.onload = function() {
            if (savedName && savedPhone) {
                // Auto-login as patient
                document.getElementById('name-input').value = savedName;
                document.getElementById('phone-input').value = savedPhone;
                // Uncomment below for auto-login (optional)
                // setTimeout(() => startApp(), 500);
            }
        };
    </script>
</body>
</html>
