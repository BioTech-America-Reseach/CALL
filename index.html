<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dr. William Clinic</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #000;
            --card: #111;
            --gold: #d4af37;
            --green: #22c55e;
            --gray: #6b7280;
            --text: #f1f5f9;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
        body, html {
            height:100%; width:100%; background:var(--bg); color:var(--text);
            overflow:hidden; position:fixed;
        }
        #login-screen {
            position:fixed; inset:0; background:linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1617791160505-6f00504e3519?q=80&w=1974&auto=format&fit=crop') center/cover;
            display:flex; justify-content:center; align-items:center; z-index:10000;
        }
        .login-box {
            background:rgba(17,17,17,0.92); backdrop-filter:blur(12px);
            border:1px solid rgba(212,175,55,0.3); border-radius:20px;
            padding:35px 25px; width:90%; max-width:380px; text-align:center;
            box-shadow:0 15px 50px rgba(0,0,0,0.8);
        }
        .login-box h2 { color:var(--gold); font-size:1.8rem; margin-bottom:20px; }
        .login-box input {
            width:100%; padding:14px; margin:12px 0; border-radius:12px;
            border:1px solid #444; background:#1a1a1a; color:white; font-size:1rem;
        }
        .login-box button {
            width:100%; padding:14px; margin-top:15px; background:var(--gold);
            color:black; border:none; border-radius:12px; font-weight:600; cursor:pointer;
        }
        .doctor-hint { color:var(--gold); font-size:0.85rem; margin-top:15px; cursor:pointer; }

        /* Main */
        #main-interface { display:none; flex-direction:column; height:100%; }
        .header {
            padding:14px 18px; background:#0a0a0a; border-bottom:1px solid rgba(212,175,55,0.2);
            display:flex; justify-content:space-between; align-items:center;
        }
        .header h3 { color:var(--gold); font-size:1.3rem; }
        .status-dot {
            width:10px; height:10px; border-radius:50%; margin-left:8px;
            background:var(--green); box-shadow:0 0 8px var(--green);
        }
        .status-dot.off { background:var(--gray); box-shadow:none; }

        /* Dashboard (Daktari) */
        #doctor-dashboard {
            flex:1; overflow-y:auto; padding:18px; background:#050505;
        }
        .patient-card {
            background:#111; padding:16px; border-radius:14px; margin-bottom:12px;
            border-left:5px solid var(--gold); display:flex; justify-content:space-between;
            align-items:center; transition:0.3s;
        }
        .patient-card:hover { transform:translateX(5px); }
        .patient-info strong { color:var(--text); }
        .patient-info small { color:#aaa; display:block; margin-top:4px; }
        .patient-actions button {
            padding:8px 14px; margin-left:8px; border:none; border-radius:8px;
            cursor:pointer; font-size:0.85rem;
        }
        .btn-wait { background:#eab308; color:black; }
        .btn-remove { background:#ef4444; color:white; }

        /* Chat */
        #chat-interface { flex:1; display:flex; flex-direction:column; }
        .chat-messages {
            flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column;
            gap:10px; padding-bottom:100px;
        }
        .message {
            max-width:80%; padding:10px 14px; border-radius:16px; font-size:0.95rem;
        }
        .msg-me { background:var(--gold); color:black; align-self:flex-end; }
        .msg-other { background:#222; color:white; align-self:flex-start; }

        .typing-area {
            position:fixed; bottom:0; left:0; right:0;
            background:rgba(10,10,10,0.95); backdrop-filter:blur(10px);
            border-top:1px solid rgba(212,175,55,0.15); padding:12px;
            display:flex; gap:10px; align-items:center; z-index:3000;
            transition:bottom 0.4s ease;
        }
        .typing-area.keyboard-open { bottom:40vh; }
        #msg-input {
            flex:1; padding:12px 16px; border-radius:30px; border:1px solid #444;
            background:#1a1a1a; color:white; font-size:1rem; outline:none;
        }
        .btn-send {
            width:50px; height:50px; background:var(--gold); border:none;
            border-radius:50%; color:black; font-size:1.3rem; cursor:pointer;
        }

        /* Notification Popup */
        #notification {
            position:fixed; top:20px; left:50%; transform:translateX(-50%);
            background:rgba(34,197,94,0.9); color:white; padding:12px 24px;
            border-radius:12px; z-index:9999; display:none; box-shadow:0 5px 20px rgba(0,0,0,0.5);
            font-weight:500; white-space:nowrap;
        }
    </style>
</head>
<body>

    <div id="notification"></div>

    <!-- Login -->
    <div id="login-screen">
        <div class="login-box">
            <h2>DR. WILLIAM CLINIC</h2>
            <input type="text" id="name-input" placeholder="Jina Lako">
            <input type="tel" id="phone-input" placeholder="Namba ya Simu (10 tarakimu)" maxlength="10" pattern="[0-9]{10}">
            <input type="password" id="doctor-code" placeholder="PIN ya Daktari (W005)" style="display:none;">
            <div onclick="document.getElementById('doctor-code').style.display='block'" class="doctor-hint">
                <i class="fas fa-user-md"></i> Mimi ni Daktari
            </div>
            <button onclick="startApp()">INGIA</button>
        </div>
    </div>

    <!-- Main -->
    <div id="main-interface" style="display:none;">
        <div class="header">
            <h3>Dr. William Clinic <span id="doctor-status" class="status-dot off"></span></h3>
            <button id="back-btn" onclick="backToDashboard()" style="display:none;">Rudi</button>
        </div>

        <!-- Doctor Dashboard -->
        <div id="doctor-dashboard">
            <h4 style="color:#aaa; margin-bottom:15px;">Wagonjwa Wanaosubiri</h4>
            <div id="patient-list"></div>
        </div>

        <!-- Chat -->
        <div id="chat-interface" style="display:none;">
            <div class="chat-messages" id="chat-flow"></div>
            <div class="typing-area" id="typing-box">
                <input type="text" id="msg-input" placeholder="Andika ujumbe...">
                <button class="btn-send" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script>
        // ================= FIREBASE =================
        const firebaseConfig = {
            databaseURL: "https://drwilliamtz-e44aa-default-rtdb.europe-west1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ================= VARS =================
        let myName = localStorage.getItem('chatName') || "";
        let myPhone = localStorage.getItem('chatPhone') || "";
        let isDoctor = false;
        let activeRoomId = "";

        // Auto-fill from memory
        if (myName) document.getElementById('name-input').value = myName;
        if (myPhone) document.getElementById('phone-input').value = myPhone;

        // ================= START APP =================
        function startApp() {
            myName = document.getElementById('name-input').value.trim();
            myPhone = document.getElementById('phone-input').value.trim();
            const code = document.getElementById('doctor-code').value.trim();

            if (!myName || myPhone.length !== 10 || !/^[0-9]{10}$/.test(myPhone)) {
                return alert("Weka jina na namba sahihi ya simu (tarakimu 10 tu)");
            }

            localStorage.setItem('chatName', myName);
            localStorage.setItem('chatPhone', myPhone);

            if (code === "W005") {
                isDoctor = true;
                showDashboard();
            } else {
                activeRoomId = "chat_" + myPhone;
                db.ref('patients/' + activeRoomId).set({
                    name: myName,
                    phone: myPhone,
                    online: true,
                    status: "waiting",
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    openChat(activeRoomId, "Dr. William");
                    notifyDoctorNewPatient(myName);
                });
            }

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-interface').style.display = 'flex';
        }

        // ================= DOCTOR DASHBOARD =================
        function showDashboard() {
            document.getElementById('doctor-dashboard').style.display = 'block';
            document.getElementById('chat-interface').style.display = 'none';
            loadPatients();
            document.getElementById('doctor-status').classList.remove('off');
            document.getElementById('doctor-status').classList.add('status-dot');
        }

        function loadPatients() {
            db.ref('patients').on('value', snap => {
                const list = document.getElementById('patient-list');
                list.innerHTML = '';
                snap.forEach(child => {
                    const data = child.val();
                    const card = document.createElement('div');
                    card.className = 'patient-card';
                    const dotColor = data.online ? 'green' : 'gray';
                    card.innerHTML = `
                        <div>
                            <strong>${data.name}</strong><br>
                            <small>${data.phone}</small><br>
                            <small style="color:${dotColor};">${data.online ? 'Online' : 'Offline'} â€¢ ${data.status || 'waiting'}</small>
                        </div>
                        <div>
                            <button class="btn-wait" onclick="setWaiting('${child.key}')">Subiri</button>
                            <button class="btn-remove" onclick="removePatient('${child.key}')">Ondoa</button>
                        </div>
                    `;
                    card.onclick = (e) => {
                        if (!e.target.tagName === 'BUTTON') openChat(child.key, data.name);
                    };
                    list.appendChild(card);
                });
            });
        }

        function setWaiting(patientId) {
            db.ref('patients/' + patientId).update({ status: "waiting" });
            alert("Mgonjwa amesubirishwa.");
        }

        function removePatient(patientId) {
            if (confirm("Ondoa mgonjwa kabisa? Hataweza kuingia tena.")) {
                db.ref('patients/' + patientId).remove();
                db.ref('messages/' + patientId).remove();
                alert("Mgonjwa amefutwa kabisa.");
            }
        }

        // ================= NOTIFICATION FOR NEW PATIENT =================
        function notifyDoctorNewPatient(name) {
            const notif = document.getElementById('notification');
            notif.textContent = `Mgonjwa mpya: ${name} ameingia!`;
            notif.style.display = 'block';
            document.getElementById('notifSound').play().catch(()=>{});
            setTimeout(() => notif.style.display = 'none', 5000);
        }

        // ================= CHAT =================
        function openChat(roomId, title) {
            activeRoomId = roomId;
            document.getElementById('chat-title').textContent = title;
            document.getElementById('doctor-dashboard').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'flex';

            const flow = document.getElementById('chat-flow');
            flow.innerHTML = '';

            db.ref('messages/' + roomId).on('child_added', snap => {
                const msg = snap.val();
                const div = document.createElement('div');
                div.className = `message ${msg.sender === "Dr. William" ? 'msg-me' : 'msg-other'}`;
                div.innerHTML = `${msg.text}`;
                flow.appendChild(div);
                flow.scrollTop = flow.scrollHeight;
            });
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            db.ref('messages/' + activeRoomId).push({
                sender: isDoctor ? "Dr. William" : myName,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            input.value = '';
        }

        // ================= KEYBOARD HANDLING =================
        const typingBox = document.getElementById('typing-box');
        document.getElementById('msg-input').addEventListener('focus', () => {
            typingBox.classList.add('keyboard-open');
            setTimeout(() => document.getElementById('chat-flow').scrollTop = document.getElementById('chat-flow').scrollHeight, 300);
        });
        document.getElementById('msg-input').addEventListener('blur', () => {
            typingBox.classList.remove('keyboard-open');
        });
    </script>
</body>
</html>
